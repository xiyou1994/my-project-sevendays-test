name: Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout Code
      uses: actions/checkout@v4

    # è®¾ç½® Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24.11.0'

    # è®¾ç½® pnpm
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9

    # è·å– pnpm store ç›®å½•
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    # ç¼“å­˜ä¾èµ–
    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    # å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile

    # å®‰å…¨ç‰ˆæœ¬éªŒè¯
    - name: Verify Security Versions
      run: |
        echo "ğŸ”’ éªŒè¯å®‰å…¨ç‰ˆæœ¬..."

        # æ£€æŸ¥ Next.js ç‰ˆæœ¬ - ä» package.json ç›´æ¥è¯»å–
        NEXT_VERSION=$(node -p "require('./package.json').dependencies.next")
        echo "æ£€æµ‹åˆ° Next.js ç‰ˆæœ¬: $NEXT_VERSION"

        if [[ "$NEXT_VERSION" == "15.4.8" ]]; then
          echo "âœ… Next.js ç‰ˆæœ¬å®‰å…¨: $NEXT_VERSION (CVE-2025-66478 å·²ä¿®å¤)"
        else
          echo "âŒ Next.js ç‰ˆæœ¬ä¸å®‰å…¨: $NEXT_VERSION (éœ€è¦ 15.4.8)"
          echo "è¯·ç¡®ä¿ package.json ä¸­ next ç‰ˆæœ¬ä¸º 15.4.8"
          exit 1
        fi

        # æ£€æŸ¥ React ç‰ˆæœ¬
        REACT_VERSION=$(node -p "require('./package.json').dependencies.react.replace(/^\^/, '')")
        echo "æ£€æµ‹åˆ° React ç‰ˆæœ¬: $REACT_VERSION"

        if [[ "$REACT_VERSION" == "19.2.1" ]]; then
          echo "âœ… React ç‰ˆæœ¬å®‰å…¨: $REACT_VERSION (CVE-2025-55182 å·²ä¿®å¤)"
        else
          echo "âŒ React ç‰ˆæœ¬ä¸å®‰å…¨: $REACT_VERSION (éœ€è¦ 19.2.1)"
          echo "è¯·ç¡®ä¿ package.json ä¸­ react ç‰ˆæœ¬ä¸º 19.2.1"
          exit 1
        fi

        echo "âœ… æ‰€æœ‰å®‰å…¨ç‰ˆæœ¬éªŒè¯é€šè¿‡ï¼"

    # æ„å»ºé¡¹ç›®
    - name: Build project
      run: pnpm build
      env:
        NODE_ENV: production

    # æ‰“åŒ…æ„å»ºäº§ç‰©
    - name: Package build artifacts
      run: |
        mkdir -p deploy-package
        cp -r .next deploy-package/
        cp -r public deploy-package/
        cp package.json deploy-package/
        cp pnpm-lock.yaml deploy-package/
        cp ecosystem.config.js deploy-package/
        cp next.config.mjs deploy-package/
        cp .env deploy-package/
        tar -czf deploy.tar.gz deploy-package/

    # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°æœåŠ¡å™¨
    - name: Upload to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "deploy.tar.gz"
        target: "/tmp/"

    # éƒ¨ç½²åˆ°æœåŠ¡å™¨
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        command_timeout: 30m
        script: |
          set -e

          # åŠ è½½ nvm ç¯å¢ƒï¼ˆå¦‚æœä½¿ç”¨ nvm å®‰è£…çš„ nodeï¼‰
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          # å®šä¹‰å˜é‡
          APP_DIR="/www/wwwroot/pixmind"

          echo "========================================="
          echo "å¼€å§‹éƒ¨ç½² Pixmind"
          echo "æ—¶é—´: $(date)"
          echo "Node ç‰ˆæœ¬: $(node -v 2>/dev/null || echo 'æœªå®‰è£…')"
          echo "npm ç‰ˆæœ¬: $(npm -v 2>/dev/null || echo 'æœªå®‰è£…')"
          echo "========================================="

          # åˆ›å»ºç›®å½•ç»“æ„ï¼ˆç›®å½•åº”è¯¥å·²æ‰‹åŠ¨åˆ›å»ºå¹¶è®¾ç½®å¥½æƒé™ï¼‰
          echo "[1/8] æ£€æŸ¥ç›®å½•ç»“æ„..."
          if [ ! -d "${APP_DIR}" ]; then
            echo "é”™è¯¯ï¼šç›®å½• ${APP_DIR} ä¸å­˜åœ¨ï¼"
            echo "è¯·åœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆä¸€æ¬¡æ€§æ“ä½œï¼‰ï¼š"
            echo "  sudo mkdir -p ${APP_DIR}"
            echo "  sudo chown -R \$USER:\$USER ${APP_DIR}"
            echo "  sudo chmod -R 755 ${APP_DIR}"
            exit 1
          fi

          echo "ç›®å½•æ£€æŸ¥é€šè¿‡: ${APP_DIR}"

          # å°è¯•åˆ›å»ºæ—¥å¿—ç›®å½•ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨ sudoï¼ˆé¿å… set -e å¯¼è‡´é€€å‡ºï¼‰
          mkdir -p ${APP_DIR}/logs 2>/dev/null || {
            echo "è­¦å‘Šï¼šæ— æ³•åˆ›å»ºæ—¥å¿—ç›®å½•ï¼Œå°è¯•ä½¿ç”¨ sudo ä¿®å¤æƒé™..."
            sudo mkdir -p ${APP_DIR}/logs || true
            sudo chown -R $USER:$USER ${APP_DIR} || true
            sudo chmod -R 755 ${APP_DIR} || true

            # å†æ¬¡å°è¯•åˆ›å»º
            if ! mkdir -p ${APP_DIR}/logs 2>/dev/null; then
              echo "âŒ é”™è¯¯ï¼šä»ç„¶æ— æ³•åˆ›å»ºç›®å½•ï¼"
              echo "è¯·åœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"
              echo "  sudo chown -R \$USER:\$USER /www/wwwroot/pixmind"
              echo "  sudo chmod -R 755 /www/wwwroot/pixmind"
              exit 1
            fi
            echo "âœ… æƒé™ä¿®å¤æˆåŠŸ"
          }

          cd ${APP_DIR}

          # è§£å‹æ–°ç‰ˆæœ¬
          echo "[2/7] è§£å‹æ–°ç‰ˆæœ¬..."
          tar -xzf /tmp/deploy.tar.gz -C /tmp/

          # åœæ­¢æ—§æœåŠ¡
          echo "[3/7] åœæ­¢æ—§æœåŠ¡..."
          if command -v pm2 &> /dev/null; then
            pm2 stop pixmind || true
            pm2 delete pixmind || true
          else
            echo "PM2 æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
            npm install -g pm2
          fi

          # ç­‰å¾…æœåŠ¡å®Œå…¨åœæ­¢
          echo "ç­‰å¾…æœåŠ¡å®Œå…¨åœæ­¢..."
          sleep 5

          # å¼ºåˆ¶æ€æ­»å ç”¨3006ç«¯å£çš„è¿›ç¨‹ï¼ˆç¡®ä¿ç«¯å£æ¸…ç†ï¼‰
          echo "æ¸…ç†å ç”¨3006ç«¯å£çš„è¿›ç¨‹..."
          for i in {1..3}; do
            PID=$(lsof -ti:3006 || true)
            if [ ! -z "$PID" ]; then
              echo "å‘ç°å ç”¨ç«¯å£çš„è¿›ç¨‹ PID: $PIDï¼Œæ­£åœ¨å¼ºåˆ¶æ€æ­»... (å°è¯• $i/3)"
              kill -9 $PID || true
              sleep 3
            else
              echo "ç«¯å£3006å·²æ¸…ç†å®Œæˆ"
              break
            fi
          done

          # æœ€åæ£€æŸ¥ç«¯å£æ˜¯å¦è¢«é‡Šæ”¾
          if lsof -ti:3006 >/dev/null 2>&1; then
            echo "è­¦å‘Šï¼šç«¯å£3006ä»è¢«å ç”¨ï¼Œå°è¯•ä½¿ç”¨fuserå¼ºåˆ¶æ¸…ç†..."
            fuser -k 3006/tcp || true
            sleep 2
          fi

          # å¤åˆ¶æ–°æ–‡ä»¶
          echo "[4/7] å¤åˆ¶æ–°æ–‡ä»¶..."
          cp -rf /tmp/deploy-package/.next ${APP_DIR}/
          cp -rf /tmp/deploy-package/public ${APP_DIR}/
          cp -f /tmp/deploy-package/package.json ${APP_DIR}/
          cp -f /tmp/deploy-package/pnpm-lock.yaml ${APP_DIR}/
          cp -f /tmp/deploy-package/ecosystem.config.js ${APP_DIR}/
          cp -f /tmp/deploy-package/next.config.mjs ${APP_DIR}/
          cp -f /tmp/deploy-package/.env ${APP_DIR}/

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/deploy-package
          rm -f /tmp/deploy.tar.gz

          # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼Œå› ä¸º next.config.mjs éœ€è¦ï¼‰
          echo "[5/7] å®‰è£…ä¾èµ–..."
          if ! command -v pnpm &> /dev/null; then
            echo "pnpm æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
            npm install -g pnpm
          fi

          # æ³¨æ„ï¼šä¸ä½¿ç”¨ --prodï¼Œå› ä¸º next.config.mjs éœ€è¦ devDependencies
          pnpm install --frozen-lockfile

          # å¯åŠ¨æœåŠ¡
          echo "[6/7] å¯åŠ¨æœåŠ¡..."
          pm2 start ecosystem.config.js
          pm2 save

          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          echo "[7/7] æœåŠ¡çŠ¶æ€ï¼š"
          pm2 list
          pm2 info pixmind

          echo "========================================="
          echo "éƒ¨ç½²å®Œæˆï¼"
          echo "åº”ç”¨åç§°: pixmind"
          echo "è¿è¡Œç«¯å£: 3006"
          echo "éƒ¨ç½²ç›®å½•: ${APP_DIR}"
          echo "å¤‡ä»½ç­–ç•¥: æ— å¤‡ä»½"
          echo "========================================="

    # å¥åº·æ£€æŸ¥
    - name: Health Check
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # åŠ è½½ nvm ç¯å¢ƒ
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."

          # æ£€æŸ¥ PM2 è¿›ç¨‹çŠ¶æ€
          if ! pm2 list | grep -q "pixmind.*online"; then
            echo "é”™è¯¯ï¼šåº”ç”¨æœªè¿è¡Œï¼"
            pm2 logs pixmind --lines 50 --nostream
            exit 1
          fi

          # HTTP å¥åº·æ£€æŸ¥
          MAX_ATTEMPTS=10
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "å¥åº·æ£€æŸ¥å°è¯• $ATTEMPT/$MAX_ATTEMPTS..."

            # æ£€æŸ¥ç«¯å£
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3006 || echo "000")
            echo "å“åº”ç : $HTTP_CODE"

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "307" ] || [ "$HTTP_CODE" = "308" ]; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
              echo "åº”ç”¨çŠ¶æ€ï¼š"
              pm2 info pixmind
              echo "ç«¯å£ç›‘å¬çŠ¶æ€ï¼š"
              netstat -tlpn | grep ':3006' || ss -tlpn | grep ':3006' || true
              exit 0
            else
              echo "ç­‰å¾…æœåŠ¡å“åº”..."
              sleep 5
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          # å¥åº·æ£€æŸ¥å¤±è´¥
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼"
          echo "PM2 è¿›ç¨‹çŠ¶æ€ï¼š"
          pm2 list
          echo "åº”ç”¨æ—¥å¿—ï¼š"
          pm2 logs pixmind --lines 100 --nostream
          exit 1

    # æ¸…ç†å·¥ä½œæµäº§ç‰©
    - name: Cleanup
      if: always()
      run: |
        rm -f deploy.tar.gz
        rm -rf deploy-package

    # æˆåŠŸæ—¶å‘é€é€šçŸ¥
    - name: Send Success Notification
      if: success() && github.event_name == 'push'
      run: |
        echo "éƒ¨ç½²æˆåŠŸé€šçŸ¥"
        curl -X POST -H "Content-Type: application/json" \
          -d '{
             "msgtype": "text",
             "text": {
               "content": "âœ… Pixmind éƒ¨ç½²æˆåŠŸï¼\nåˆ†æ”¯ï¼š${{ github.ref_name }}\næ‰§è¡Œäººï¼š${{ github.actor }}\næäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message }}"
             }
           }' \
           "${{ secrets.NOTIFICATION_WEBHOOK }}" || true

    # å¤±è´¥æ—¶å‘é€é€šçŸ¥
    - name: Send Failure Notification
      if: failure()
      run: |
        echo "éƒ¨ç½²å¤±è´¥é€šçŸ¥"
        curl -X POST -H "Content-Type: application/json" \
           -d '{
             "msgtype": "text",
             "text": {
               "content": "âŒ Pixmind éƒ¨ç½²å¤±è´¥ï¼\nåˆ†æ”¯ï¼š${{ github.ref_name }}\næ‰§è¡Œäººï¼š${{ github.actor }}\nè¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—"
             }
           }' \
           "${{ secrets.NOTIFICATION_WEBHOOK }}" || true
